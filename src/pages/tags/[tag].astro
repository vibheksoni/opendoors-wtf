---
import { getCollection } from 'astro:content';
import BaseHead from '../../components/BaseHead.astro';
import Footer from '../../components/Footer.astro';
import FormattedDate from '../../components/FormattedDate.astro';
import Header from '../../components/Header.astro';
import { siteConfig } from '../../config/site';
import { SITE_DESCRIPTION, SITE_TITLE } from '../../consts';
import { buildBreadcrumbJsonLd } from '../../utils/jsonLd';
import { sortPosts } from '../../utils/posts';
import { toTitle } from '../../utils/tags';

export async function getStaticPaths() {
	const posts = sortPosts(await getCollection('blog'));
	const tags = new Set(posts.flatMap((post) => post.data.tags));

	return Array.from(tags).map((tag) => ({
		params: { tag },
		props: { tag },
	}));
}

const { tag } = Astro.props;
const posts = sortPosts(await getCollection('blog')).filter((post) => post.data.tags.includes(tag));
const jsonLd = buildBreadcrumbJsonLd([
	{ name: 'Home', url: Astro.site?.toString() ?? siteConfig.site },
	{ name: 'Tags', url: new URL('/tags/', Astro.site ?? siteConfig.site).toString() },
	{ name: toTitle(tag), url: new URL(`/tags/${tag}/`, Astro.site ?? siteConfig.site).toString() },
]);

const basePath = import.meta.env.BASE_URL;
const withBase = (path: string) => {
	const normalized = path.replace(/^\//, '');
	return basePath.endsWith('/') ? `${basePath}${normalized}` : `${basePath}/${normalized}`;
};
---

<!doctype html>
<html lang="en">
	<head>
		<BaseHead title={toTitle(tag)} description={SITE_DESCRIPTION} jsonLd={jsonLd} />
	</head>
	<body>
		<Header />
		<main>
			<h1>{toTitle(tag)}</h1>
			<ul class="post-grid">
				{posts.map((post) => (
					<li>
						<a href={withBase(`/blog/${post.id}/`)}>
							<h3>{post.data.title}</h3>
							<p>{post.data.description}</p>
							<FormattedDate date={post.data.pubDate} />
						</a>
					</li>
				))}
			</ul>
		</main>
		<Footer />
	</body>
</html>

<style>
	.post-grid {
		list-style: none;
		margin: 1.5rem 0 0;
		padding: 0;
		display: grid;
		gap: 1.5rem;
	}
	.post-grid a {
		display: block;
		border: 1px solid rgb(var(--gray-light));
		border-radius: 16px;
		padding: 1rem 1.25rem;
		text-decoration: none;
		color: inherit;
	}
	.post-grid a:hover {
		box-shadow: var(--box-shadow);
	}
</style>
